<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KKDash - Linux System Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container pt-3 pb-5">
        <header class="mb-5 d-flex justify-content-between align-items-end">
            <div>
                <h1 class="fw-900 display-5 mb-0">KK<span style="color: var(--accent-primary)">Dash</span> üöÄ</h1>
                <p class="text-secondary opacity-75 fs-5" id="os-name">Initializing core systems...</p>
            </div>
            <div class="text-end pb-2">
                <div class="d-flex align-items-center justify-content-end mb-2">
                    <span class="pulse"></span>
                    <span class="fw-bold small" style="color: var(--accent-secondary); letter-spacing: 2px;">NEON
                        LIVE</span>
                </div>
                <small class="text-secondary font-monospace" id="last-update">Updating...</small>
            </div>
        </header>

        <div class="row g-4">
            <!-- CPU Card -->
            <div class="col-md-6 col-lg-4">
                <div class="glass-card p-4 h-100">
                    <div class="stat-label mb-2">‚ö° Processor Power</div>
                    <div class="stat-value mb-1" id="cpu-usage">--%</div>
                    <div class="text-secondary small mb-3"><span id="cpu-cores">--</span> Cores Active üß†</div>
                    <div class="progress mb-3">
                        <div id="cpu-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="text-secondary small text-truncate fw-medium" id="cpu-model">Detecting...</div>
                </div>
            </div>

            <!-- Memory Card -->
            <div class="col-md-6 col-lg-4">
                <div class="glass-card p-4 h-100">
                    <div class="stat-label mb-2">üíé Memory</div>
                    <div class="stat-value mb-1" id="mem-percent">--%</div>
                    <div class="text-secondary small mb-3">Buffer status optimal</div>
                    <div class="progress mb-3">
                        <div id="mem-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between text-secondary small fw-bold">
                        <span id="mem-used">--</span>
                        <span>/</span>
                        <span id="mem-total">--</span>
                    </div>
                </div>
            </div>

            <!-- Services & Users -->
            <div class="col-md-6 col-lg-4">
                <div class="glass-card p-4 h-100">
                    <div class="stat-label mb-3">üõ†Ô∏è System Services</div>
                    <div id="services-list" class="mb-4">
                        <!-- Services injected here -->
                    </div>

                    <div class="stat-label mb-2">üë§ Active Operators</div>
                    <div id="users-list" class="d-flex flex-wrap gap-2">
                        <!-- Users injected here -->
                    </div>
                </div>
            </div>

            <!-- Mounts Card -->
            <div class="col-12">
                <div class="glass-card p-4">
                    <div class="stat-label mb-4" style="color: #fbbf24">üìÇ Filesystems</div>
                    <div class="table-responsive">
                        <table class="table align-middle mb-0 w-100 text-white minimal-table"
                            style="background: transparent; border: none;">
                            <thead>
                                <tr class="text-secondary small text-uppercase">
                                    <th>Mount Target üìç</th>
                                    <th>Volume üíæ</th>
                                    <th>Capacity üìä</th>
                                    <th>Allocation üìè</th>
                                </tr>
                            </thead>
                            <tbody id="mounts-body">
                                <!-- Mounts injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Docker Containers Card -->
            <div class="col-12" id="docker-card-container">
                <div class="glass-card p-4">
                    <div class="stat-label mb-4">üì¶ Containers (Docker)</div>
                    <div class="table-responsive">
                        <table class="table align-middle mb-0 w-100 text-white minimal-table"
                            style="background: transparent; border: none;">
                            <thead>
                                <tr class="text-secondary small text-uppercase">
                                    <th>Entity Name üè∑Ô∏è</th>
                                    <th>Core Image üíø</th>
                                    <th>Operational State üö¶</th>
                                </tr>
                            </thead>
                            <tbody id="docker-body">
                                <!-- Docker data injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- UFW Firewall Stats Card -->
            <div class="col-12" id="ufw-card-container">
                <div class="glass-card p-4">
                    <div class="stat-label mb-4" style="color: #60a5fa">üî• Firewall Intelligence (UFW)</div>
                    <div class="row align-items-center">
                        <div class="col-lg-7">
                            <div class="table-responsive">
                                <table class="table align-middle mb-0 w-100 text-white minimal-table"
                                    style="background: transparent; border: none;">
                                    <thead>
                                        <tr class="text-secondary small text-uppercase">
                                            <th>Source IP üåê</th>
                                            <th>Target Port üö™</th>
                                            <th>Attempts üìä</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ufw-body">
                                        <!-- UFW data injected here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-lg-5 text-center mt-4 mt-lg-0">
                            <div style="height:250px; width:100%; display: flex; justify-content: center;">
                                <canvas id="ufwChart"></canvas>
                            </div>
                            <div class="text-secondary small mt-2 fw-bold">Top 10 Target Port Distribution üéØ</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fail2Ban Stats Card -->
            <div class="col-12" id="f2b-card-container">
                <div class="glass-card p-4">
                    <div class="stat-label mb-4" style="color: #f87171">üõ°Ô∏è Intrusion Prevention (Fail2Ban)</div>
                    <div class="row">
                        <!-- Monthly Top -->
                        <div class="col-lg-4 border-end border-white border-opacity-10">
                            <div class="text-secondary small mb-3 fw-bold border-start border-danger ps-2">Top 10
                                Monthly Blocks üìÖ</div>
                            <div class="table-responsive">
                                <table class="table align-middle mb-0 w-100 text-white minimal-table"
                                    style="font-size: 0.85rem;">
                                    <thead>
                                        <tr class="text-secondary small text-uppercase">
                                            <th>IP Address</th>
                                            <th>Jail</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="f2b-monthly-body">
                                        <!-- Data injected here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Currently Banned -->
                        <div class="col-lg-4">
                            <div class="text-secondary small mb-3 fw-bold border-start border-warning ps-2">Active
                                Banned Entities üö¶</div>
                            <div class="table-responsive">
                                <table class="table align-middle mb-0 w-100 text-white minimal-table"
                                    style="font-size: 0.85rem;">
                                    <thead>
                                        <tr class="text-secondary small text-uppercase">
                                            <th>IP Address</th>
                                            <th>Active Jail</th>
                                        </tr>
                                    </thead>
                                    <tbody id="f2b-current-body">
                                        <!-- Data injected here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Jail Distribution Chart -->
                        <div class="col-lg-4 text-center mt-4 mt-lg-0">
                            <div style="height:250px; width:100%; display: flex; justify-content: center;">
                                <canvas id="f2bChart"></canvas>
                            </div>
                            <div class="text-secondary small mt-2 fw-bold">Jail Distribution üéØ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-5 pt-4 text-center border-top border-white border-opacity-5">
            <p class="mb-0">‚ú® <a href="https://github.com/kamilkobak/kkdash" target="_blank"
                    class="text-decoration-none text-inherit alternate-link">KKDash &bull; Linux System
                    Dashboard</a> ‚ú®
            </p>
            <small class="text-secondary" id="uptime-display">--</small>
        </footer>
    </div>

    <script>
        let ufwChart = null;
        let f2bChart = null;

        function isPrivateIP(ip) {
            const parts = ip.split('.');
            if (parts.length !== 4) return false;
            const first = parseInt(parts[0]);
            const second = parseInt(parts[1]);

            // 10.0.0.0/8
            if (first === 10) return true;
            // 172.16.0.0/12
            if (first === 172 && second >= 16 && second <= 31) return true;
            // 192.168.0.0/16
            if (first === 192 && second === 168) return true;
            // 127.0.0.0/8
            if (first === 127) return true;

            return false;
        }

        function getRipeLink(ip) {
            if (isPrivateIP(ip)) return '';
            return `<a href="https://apps.db.ripe.net/db-web-ui/query?from=www&searchtext=${ip}" 
                       target="_blank" class="ms-1 text-decoration-none" title="Lookup on RIPE">üîç</a>`;
        }

        async function updateDashboard() {
            try {
                const response = await fetch('data.json');
                const data = await response.json();

                // CPU
                document.getElementById('cpu-usage').innerText = data.cpu.usage;
                document.getElementById('cpu-progress').style.width = data.cpu.usage;
                document.getElementById('cpu-model').innerText = data.cpu.model;
                document.getElementById('cpu-cores').innerText = data.cpu.cores;

                // Memory
                document.getElementById('mem-percent').innerText = data.memory.percent;
                document.getElementById('mem-progress').style.width = data.memory.percent;
                document.getElementById('mem-used').innerText = data.memory.used;
                document.getElementById('mem-total').innerText = data.memory.total;

                // Services
                const servicesList = document.getElementById('services-list');
                servicesList.innerHTML = '';
                for (const [name, status] of Object.entries(data.services)) {
                    const statusIcon = status === 'active' ? 'üü¢' : 'üî¥';
                    const badgeClass = status === 'active' ? 'bg-success' : 'bg-danger';
                    servicesList.innerHTML += `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-secondary small text-uppercase fw-bold">${name}</span>
                            <span class="badge ${badgeClass} text-uppercase shadow-sm">${statusIcon} ${status}</span>
                        </div>
                    `;
                }

                // Users
                const usersList = document.getElementById('users-list');
                usersList.innerHTML = data.users.map(user =>
                    `<span class="badge badge-outline-neon shadow-sm px-3 py-2">‚ö° ${user}</span>`
                ).join('') || '<span class="text-secondary italic small">No active operators</span>';

                // Mounts
                const mountsBody = document.getElementById('mounts-body');
                mountsBody.innerHTML = data.mounts.map(m => {
                    const percentUsed = parseInt(m.percent);
                    let colorClass = 'bg-success';
                    if (percentUsed >= 90) colorClass = 'bg-danger';
                    else if (percentUsed >= 70) colorClass = 'bg-warning';

                    return `
                        <tr>
                            <td class="fw-bold text-white">${m.target}</td>
                            <td class="text-secondary small font-monospace">${m.source}</td>
                            <td style="width: 30%">
                                <div class="progress" style="height: 8px">
                                    <div class="progress-bar ${colorClass}" role="progressbar" style="width: ${m.percent}"></div>
                                </div>
                            </td>
                            <td class="text-secondary small fw-bold">${m.used} / ${m.size}</td>
                        </tr>
                    `;
                }).join('');

                // Docker Containers
                const dockerCardContainer = document.getElementById('docker-card-container');

                if (data.docker_containers === null) {
                    dockerCardContainer.style.display = 'none';
                } else {
                    dockerCardContainer.style.display = 'block';
                    const dockerBody = document.getElementById('docker-body');
                    dockerBody.innerHTML = data.docker_containers.map(c => {
                        const isUp = c.status.toLowerCase().includes('up');
                        const statusColor = isUp ? '#4ade80' : '#ef4444'; // Neon Green for UP
                        const statusEmoji = isUp ? '‚úîÔ∏è' : '‚ùå';
                        return `
                        <tr>
                            <td class="fw-bold text-white">${c.name}</td>
                            <td class="text-secondary small font-monospace">${c.image}</td>
                            <td style="color: ${statusColor};" class="fw-bold small">${statusEmoji} ${c.status}</td>
                        </tr>
                    `;
                    }).join('') || '<tr><td colspan="3" class="text-center text-secondary py-4 italic">No neural containers active</td></tr>';
                }

                // UFW Stats Logic
                const ufwCardContainer = document.getElementById('ufw-card-container');
                if (data.ufw && data.ufw.active) {
                    ufwCardContainer.style.display = 'block';

                    // UFW Table
                    const ufwBody = document.getElementById('ufw-body');
                    ufwBody.innerHTML = data.ufw.top_blocked.map(b => `
                        <tr>
                            <td class="fw-bold text-white">
                                ${b.ip} 
                                ${getRipeLink(b.ip)}
                            </td>
                            <td class="text-secondary small font-monospace">${b.port}</td>
                            <td class="text-secondary small fw-bold"><span class="badge bg-danger bg-opacity-25 text-danger" style="border: 1px solid rgba(239, 68, 68, 0.2)">${b.count} blocks</span></td>
                        </tr>
                    `).join('') || '<tr><td colspan="3" class="text-center text-secondary py-4 italic">No recent firewall blocks</td></tr>';

                    // UFW Chart
                    const ctx = document.getElementById('ufwChart').getContext('2d');
                    const portLabels = Object.keys(data.ufw.ports);
                    const chartData = {
                        labels: portLabels,
                        datasets: [{
                            data: Object.values(data.ufw.ports),
                            backgroundColor: [
                                '#f0abfc', '#22d3ee', '#818cf8', '#fbbf24', '#f472b6',
                                '#4ade80', '#fb7185', '#38bdf8', '#c084fc', '#94a3b8'
                            ],
                            borderWidth: 0,
                            hoverOffset: 15
                        }]
                    };

                    if (ufwChart) {
                        ufwChart.data = chartData;
                        ufwChart.update('none'); // Update without animation
                    } else if (portLabels.length > 0) {
                        ufwChart = new Chart(ctx, {
                            type: 'doughnut',
                            data: chartData,
                            options: {
                                animation: false, // Disable initial animation
                                cutout: '70%',
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            color: '#94a3b8',
                                            usePointStyle: true,
                                            padding: 20,
                                            font: { family: 'Inter', size: 11 }
                                        }
                                    }
                                }
                            }
                        });
                    }
                } else {
                    ufwCardContainer.style.display = 'none';
                }

                // Fail2Ban Stats Logic
                const f2bCardContainer = document.getElementById('f2b-card-container');
                if (data.fail2ban && data.fail2ban.active) {
                    f2bCardContainer.style.display = 'block';

                    // Monthly Table
                    const f2bMonthlyBody = document.getElementById('f2b-monthly-body');
                    f2bMonthlyBody.innerHTML = data.fail2ban.monthly_top.map(b => `
                        <tr>
                            <td class="fw-bold text-white">
                                ${b.ip}
                                ${getRipeLink(b.ip)}
                            </td>
                            <td><span class="badge bg-secondary bg-opacity-25 text-secondary border border-secondary border-opacity-25">${b.jail}</span></td>
                            <td class="text-danger fw-bold">${b.count}</td>
                        </tr>
                    `).join('') || '<tr><td colspan="3" class="text-center text-secondary py-4 italic">No monthly bans recorded</td></tr>';

                    // Current Table
                    const f2bCurrentBody = document.getElementById('f2b-current-body');
                    f2bCurrentBody.innerHTML = data.fail2ban.current_top.map(b => `
                        <tr>
                            <td class="fw-bold text-white">
                                ${b.ip}
                                ${getRipeLink(b.ip)}
                            </td>
                            <td><span class="badge bg-danger bg-opacity-25 text-danger border border-danger border-opacity-25">${b.jail}</span></td>
                        </tr>
                    `).join('') || '<tr><td colspan="2" class="text-center text-secondary py-4 italic">No active bans</td></tr>';

                    // Fail2Ban Chart
                    const ctxF2B = document.getElementById('f2bChart').getContext('2d');
                    const jailLabels = Object.keys(data.fail2ban.jails_dist);
                    const f2bChartData = {
                        labels: jailLabels,
                        datasets: [{
                            data: Object.values(data.fail2ban.jails_dist),
                            backgroundColor: [
                                '#f87171', '#fbbf24', '#34d399', '#60a5fa', '#a78bfa',
                                '#f472b6', '#fb7185', '#38bdf8', '#c084fc', '#94a3b8'
                            ],
                            borderWidth: 0,
                            hoverOffset: 15
                        }]
                    };

                    if (f2bChart) {
                        f2bChart.data = f2bChartData;
                        f2bChart.update('none');
                    } else if (jailLabels.length > 0) {
                        f2bChart = new Chart(ctxF2B, {
                            type: 'doughnut',
                            data: f2bChartData,
                            options: {
                                animation: false,
                                cutout: '70%',
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            color: '#94a3b8',
                                            usePointStyle: true,
                                            padding: 20,
                                            font: { family: 'Inter', size: 10 }
                                        }
                                    }
                                }
                            }
                        });
                    }
                } else {
                    f2bCardContainer.style.display = 'none';
                }

                // System
                document.getElementById('os-name').innerText = 'üåç ' + data.system.os + ' üñ•Ô∏è ' + data.system.hostname + ' ‚ö° ' + data.system.uptime;
                document.getElementById('last-update').innerText = 'SECURE SYNC: ' + data.system.last_update;
                document.getElementById('uptime-display').innerText = '‚è±Ô∏è Uptime: ' + data.system.uptime;

            } catch (error) {
                console.error('CRITICAL SYNC ERROR:', error);
            }
        }

        // Initial load
        updateDashboard();
        // Refresh every 5 seconds
        setInterval(updateDashboard, 5000);
    </script>
</body>

</html>